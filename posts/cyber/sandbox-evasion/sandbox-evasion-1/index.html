<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Sandbox Evasion : Théorie, techniques et pratique</title>
    <meta name="description" content="">
    <meta name="keywords" content='blog, makhal, cyber, SIEM, BUT R&amp;T, sandbox'>

    <meta property="og:url" content="https://makhal.fr/posts/cyber/sandbox-evasion/sandbox-evasion-1/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Sandbox Evasion : Théorie, techniques et pratique">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://makhal.fr/images/avatar.jpg">
    <meta property="og:image:secure_url" content="https://makhal.fr/images/avatar.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Sandbox Evasion : Théorie, techniques et pratique">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://makhal.fr/posts/cyber/sandbox-evasion/sandbox-evasion-1/">
    <meta property="twitter:url" content="https://makhal.fr/posts/cyber/sandbox-evasion/sandbox-evasion-1/">
    <meta name="twitter:image" content="https://makhal.fr/images/avatar.jpg">

    
    <link rel="canonical" href="https://makhal.fr/posts/cyber/sandbox-evasion/sandbox-evasion-1/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.893af8dd3b65bd0ffe90e7af33847bd6dc9180b8fa6d6659a212a6f4b62d3e01.js" integrity="sha256-iTr43TtlvQ/&#43;kOevM4R71tyRgLj6bWZZohKm9LYtPgE="></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6QF6WSBEBS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-6QF6WSBEBS');
    </script>
    
    
          <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">
        
        
            <div class="avatar">
                <a href="https://makhal.fr/">
                    <img src="https://makhal.fr//images/avatar.jpg" alt="avatar" />
                </a>
            </div>
        

        
        <div class="nav-title">
            <a class="nav-brand" href="https://makhal.fr/">makhal.fr</a>
        </div>

        
        <div class="nav-links">
            
                <div class="nav-link">
                    <a href="https://makhal.fr/posts/"> Posts </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://makhal.fr/tags/"> Tags </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://makhal.fr/pages/about/"> Bio </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://www.youtube.com/@makhalX"><span data-feather='youtube'></span>  </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://www.linkedin.com/in/mohamad-el-akhal-8b8319221/"><span data-feather='linkedin'></span>  </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://github.com/tutanka01"><span data-feather='github'></span>  </a>
                </div>
            

            
            <span class="nav-icons-divider"></span>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">   
                
                    <li class="nav-item">
                        <a href="https://makhal.fr/posts/"> Posts </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://makhal.fr/tags/"> Tags </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://makhal.fr/pages/about/"> Bio </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://www.youtube.com/@makhalX"><span data-feather='youtube'></span>  </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://www.linkedin.com/in/mohamad-el-akhal-8b8319221/"><span data-feather='linkedin'></span>  </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://github.com/tutanka01"><span data-feather='github'></span>  </a>
                    </li>
                
        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Sandbox Evasion : Théorie, techniques et pratique</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            avril 7, 2025
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://makhal.fr/tags/cyber">cyber</a></li>
        
            <li class="post-tag"><a href="https://makhal.fr/tags/sandbox">sandbox</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>Internet, le lieu où tout le monde peut s&rsquo;exprimer, se rencontrer et débattre. Mais une face très sombre de ce monde virtuel existe : le cybercrime, le hacking, le vol de données, la fraude, et j&rsquo;en passe.</p>
<p>Le cybercrime, ou les cyberattaques, est un sujet qui me passionne depuis longtemps. J&rsquo;ai toujours été fasciné par la façon dont les mechants hackers peuvent contourner les systèmes de sécurité et comment les entreprises et les gouvernements tentent de se protéger contre ces menaces.</p>
<p>Dans cet article, on va discuter d&rsquo;un concept très fascinant : l&rsquo;évasion de sandbox. En quoi cela consiste ? Et pourquoi est-ce si crucial dans un paysage de cybercriminalité en constante évolution ? Tout cela et bien plus encore, c&rsquo;est ce que nous allons découvrir ensemble.</p>
<h2 id="quest-ce-quune-sandbox-">Qu&rsquo;est-ce qu&rsquo;une sandbox ?</h2>
<p>Les malwares sont une réalité. Ils existent, et ils sont là pour nous faire du mal. Mais nous, simples humains, ne savons pas forcément faire la différence à vue d&rsquo;œil entre un fichier inoffensif et un fichier malveillant (encore moins les personnes qui ne sont pas du milieu de la cybersécurité).</p>
<p>C&rsquo;est là que les sandboxes entrent en jeu. Pour faire simple, une sandbox, c&rsquo;est un environnement isolé, souvent virtuel (une VM, un conteneur&hellip;), qui va nous permettre d&rsquo;exécuter des fichiers ou des liens suspects en toute sécurité.</p>
<p>Il existe plusieurs types de sandbox : isolées du réseau, connectées à internet, accessibles au public, privées, etc. Mais le principe reste le même : exécuter du code potentiellement malveillant dans un environnement contrôlé et observer son comportement.</p>
<p>Les sandboxes accessibles au public, telles que VirusTotal, peuvent être utilisées par n&rsquo;importe qui. Pour donner une idée de l&rsquo;échelle, VirusTotal traite quasiment plus de 3 millions de fichiers et 8 millions d&rsquo;URLs par jour !</p>
<p><img src="/images/cyber/sandbox/vt-stats.png" alt="alt text"></p>
<p>Rendez-vous compte de la quantité de fichiers et d&rsquo;URLs qui sont analysés chaque jour. C&rsquo;est un travail titanesque. Vous devinez donc (j&rsquo;espère) que ce sont des environnements totalement automatisés. Il est tout bonnement impossible de faire analyser 3 millions de fichiers par jour par des humains.</p>
<p>C&rsquo;est précisément parce que ces sandboxes sont automatisées qu&rsquo;elles présentent une faiblesse : qui dit automatisation dit également une possibilité de <em>fingerprinting</em> (prise d&rsquo;empreinte). Pourquoi ? Car tous ces environnements de sandbox ont tendance à se ressembler. Il s&rsquo;agit souvent de snapshots de VM ou de VM clonées avec des caractéristiques et attributs très similaires.</p>
<p>Une étude de 2016 (un peu vieille, certes, mais dont les principes restent d&rsquo;actualité, on va le voir) illustre bien cela :</p>
<blockquote>
<p><a href="https://www.christian-rossow.de/publications/sandprint-raid2016.pdf"><em>SandPrint: Fingerprinting Malware Sandboxes to Provide Intelligence for Sandbox Evasion</em></a></p>
</blockquote>
<p>Leur technique de fingerprinting consistait à envoyer un fichier exécutable, nommé &ldquo;SandPrint&rdquo;, qui, une fois exécuté dans la sandbox, était capable de récupérer des informations sur l&rsquo;environnement d&rsquo;exécution, telles que :</p>
<p><img src="/images/cyber/sandbox/features-finger.png" alt="alt text">
<em>(Source: SandPrint Paper RAID 2016)</em></p>
<p>Ils avaient ainsi un visuel global de la machine dans laquelle leur outil s&rsquo;exécutait. Cela leur a permis d&rsquo;obtenir 2661 rapports (issus de 221 exécutions effectives parmi leurs 440 soumissions) et d&rsquo;identifier 76 environnements de sandbox différents, éparpillés dans 33 pays.</p>
<p>Ils ont notamment pu constater que la plupart des sandboxes utilisaient des VM Windows, qui étaient souvent clonées depuis des années (même date d&rsquo;installation, même ID produit&hellip;).</p>
<p>Egalement, la majorité absolue tournait sur des VM VMware (on peut se demander si, avec les nouvelles tarifications de VMware, certains ne sont pas passés sous Proxmox depuis ;)).</p>
<p>En résumé, cette étude a permis de :</p>
<ul>
<li>Prouver qu’il existe des signatures identifiables dans la configuration des sandboxes.</li>
<li>Démontrer la faisabilité d&rsquo;une détection automatique (donc potentiellement utilisable par un malware) pour savoir s&rsquo;il tourne dans une sandbox et, le cas échéant, éviter de révéler sa charge utile (payload).</li>
<li>Mettre en évidence que les mêmes méthodes peuvent servir à détecter (et donc contourner) des solutions de sécurité commerciales reposant aussi sur des sandboxes Windows.</li>
</ul>
<p>Ces travaux illustrent un problème fondamental : les sandboxes, bien qu&rsquo;indispensables, ne sont pas infaillibles. Selon cette <a href="https://arxiv.org/html/2405.06124v2#:~:text=traces%20are%20diverse%2C%20which%20hurts,the%20accuracy%20of%20endpoint%20classifiers">source récente (2024)</a>, on estime qu&rsquo;entre 40% et 80% des malwares utilisent des techniques d&rsquo;évasion de sandbox. De plus, selon cette <a href="https://www.ndss-symposium.org/wp-content/uploads/2017/09/balz.pdf">étude</a>, les malwares se comportent différemment selon leur environnement d&rsquo;exécution, ce qui peut fausser et/ou compliquer les résultats de détection.</p>
<p>Pourtant, il faut noter que certains fournisseurs de sandbox affirment qu&rsquo;ils arrivent à détecter 99% des malwares.</p>
<p>Alors, qui a raison ? La réalité est probablement nuancée (les vendeurs testent peut-être contre des menaces connues, tandis que les statistiques d&rsquo;évasion reflètent l&rsquo;efficacité contre des malwares plus sophistiqués utilisant des techniques d&rsquo;évasion).</p>
<p>Déjà, de ce qui est connu et documenté, les malwares peuvent utiliser diverses techniques, notamment :</p>
<ul>
<li>Le fingerprinting (identifier les caractéristiques spécifiques de la sandbox : noms de fichiers/processus liés à la virtualisation, artefacts matériels spécifiques aux VM, etc.).</li>
<li>Le <em>delay</em> (attendre une action utilisateur spécifique, comme un mouvement de souris, ou simplement patienter un certain temps avant d&rsquo;exécuter la charge utile, partant du principe qu&rsquo;une sandbox automatisée a un temps d&rsquo;analyse limité).</li>
<li>La détection d&rsquo;IP (<a href="https://www.jstage.jst.go.jp/article/imt/6/2/6_2_633/_pdf/-char/en">vérifier si l&rsquo;adresse IP source appartient à une plage connue de datacenters ou de services d&rsquo;analyse</a>).</li>
<li>Et beaucoup d&rsquo;autres approches (détection des outils de débogage, vérification de la résolution d&rsquo;écran, etc.).</li>
</ul>
<p>Mais plusieurs papiers de recherche et articles de blog adoptent un point de vue différent. <a href="https://fudgedotdotdot.github.io/posts/sandbox-evasion-in-2024/sandboxes.html">Ils suggèrent</a> qu&rsquo;il n&rsquo;est peut-être pas judicieux pour un malware d&rsquo;essayer de détecter <em>spécifiquement</em> s&rsquo;il est dans une sandbox. Il vaudrait mieux s&rsquo;assurer que l&rsquo;environnement où il est exécuté est bien une machine &lsquo;réelle&rsquo; et utilisée par un humain.</p>
<p>Car l&rsquo;objectif principal des attaquants est de déterminer les caractéristiques d&rsquo;une machine cible légitime, plutôt que de lister toutes les sandbox possibles.</p>
<p>Par exemple, un malware pourrait :</p>
<ul>
<li>Regarder s&rsquo;il existe des fichiers de log Outlook récents et volumineux.</li>
<li>Chercher des fichiers conséquents en relation avec une activité quotidienne des produits Office.</li>
<li>Vérifier l&rsquo;uptime du système (souvent très court dans une sandbox fraîchement démarrée).</li>
<li>Regarder le nombre de cœurs CPU (parfois limité artificiellement dans les VMs d&rsquo;analyse).</li>
<li>Vérifier si la machine est jointe à un domaine Active Directory.</li>
<li>Analyser l&rsquo;historique de navigation ou la présence de certains logiciels courants non liés à l&rsquo;analyse.</li>
</ul>
<p>&hellip;Tant de petites vérifications qui peuvent aider le malware à faire la différence entre une VM de test isolée et une machine de travail potentiellement intéressante.</p>
<h2 id="un-peu-de-pratique">Un peu de pratique</h2>
<p>On va essayer de coder notre propre &ldquo;malware&rdquo;, mais celui-ci ne sera bien évidemment pas malveillant. On va simplement faire quelques checks pour voir si on tourne dans une sandbox ou pas.</p>
<p>On va vérifier si le PC a une mémoire vive suffisante (disons, au moins 4Go), si le nombre de cœurs CPU est suffisant (au moins 4 cœurs), et aussi si le PC a un uptime suffisant (au moins 5 minutes). Avec ça, on s&rsquo;assure que la VM n&rsquo;est pas trop fraîche et qu&rsquo;elle a un minimum de ressources, comme une machine utilisateur classique.</p>
<p>Car on ne peut pas s&rsquo;imaginer en 2025, un utilisateur avec moins de 4Go de RAM&hellip;</p>
<p>Tout d&rsquo;abord, voici le code C que l&rsquo;on va utiliser (Merci o1):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;wininet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib, &#34;wininet.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Paramètres heuristiques
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define MIN_REQUIRED_MEM_MB       4096   </span><span style="color:#75715e">// exiger &gt;= 4 GB RAM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define MIN_REQUIRED_CORES        4      </span><span style="color:#75715e">// exiger &gt;= 4 coeurs CPU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define MIN_UPTIME_SEC            300    </span><span style="color:#75715e">// exiger &gt;= 5 minutes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Vérifier la mémoire (RAM) totale : s&#39;il y a moins de 4Go, on suspecte un sandbox
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BOOL <span style="color:#a6e22e">isMemorySuspicious</span>() {
</span></span><span style="display:flex;"><span>    MEMORYSTATUSEX mem;
</span></span><span style="display:flex;"><span>    mem.dwLength <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(mem);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">GlobalMemoryStatusEx</span>(<span style="color:#f92672">&amp;</span>mem)) {
</span></span><span style="display:flex;"><span>        DWORDLONG totalMB <span style="color:#f92672">=</span> mem.ullTotalPhys <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1024ULL</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024ULL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (totalMB <span style="color:#f92672">&lt;</span> MIN_REQUIRED_MEM_MB) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Vérifier le nombre de cœurs CPU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BOOL <span style="color:#a6e22e">isCpuCoreSuspicious</span>() {
</span></span><span style="display:flex;"><span>    SYSTEM_INFO si;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">GetSystemInfo</span>(<span style="color:#f92672">&amp;</span>si);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// si.dwNumberOfProcessors = nombre de CPU logiques
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Sur un bac à sable, on retrouve souvent 1 ou 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (si.dwNumberOfProcessors <span style="color:#f92672">&lt;</span> MIN_REQUIRED_CORES) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Vérifier un uptime minimal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BOOL <span style="color:#a6e22e">isUptimeSuspicious</span>() {
</span></span><span style="display:flex;"><span>    DWORD upMS <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetTickCount</span>();  <span style="color:#75715e">// Valeur 32 bits, se réinitialise après ~49 jours
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD upSec <span style="color:#f92672">=</span> upMS <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000UL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (upSec <span style="color:#f92672">&lt;</span> MIN_UPTIME_SEC) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Simple fonction de connexion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">contactURL</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> url) {
</span></span><span style="display:flex;"><span>    HINTERNET hInternet <span style="color:#f92672">=</span> <span style="color:#a6e22e">InternetOpenA</span>(<span style="color:#e6db74">&#34;EvasionAgent&#34;</span>, INTERNET_OPEN_TYPE_PRECONFIG, NULL, NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (hInternet) {
</span></span><span style="display:flex;"><span>        HINTERNET hFile <span style="color:#f92672">=</span> <span style="color:#a6e22e">InternetOpenUrlA</span>(hInternet, url, NULL, <span style="color:#ae81ff">0</span>, INTERNET_FLAG_RELOAD, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (hFile) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[INFO] Requête envoyée vers %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, url);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">InternetCloseHandle</span>(hFile);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[ERROR] Impossible d&#39;ouvrir l&#39;URL: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, url);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">InternetCloseHandle</span>(hInternet);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[ERROR] InternetOpenA a échoué</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    BOOL suspicious <span style="color:#f92672">=</span> FALSE;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1) RAM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isMemorySuspicious</span>()) {
</span></span><span style="display:flex;"><span>        suspicious <span style="color:#f92672">=</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2) CPU cores
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isCpuCoreSuspicious</span>()) {
</span></span><span style="display:flex;"><span>        suspicious <span style="color:#f92672">=</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4) uptime
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isUptimeSuspicious</span>()) {
</span></span><span style="display:flex;"><span>        suspicious <span style="color:#f92672">=</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (suspicious) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// contact le site &#34;sandbox&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">contactURL</span>(<span style="color:#e6db74">&#34;http://cest-sandbox.fr&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// contact site &#34;reel&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">contactURL</span>(<span style="color:#e6db74">&#34;http://cest-reel.fr&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>De plus, pour valider notre expérimentation, on va utiliser une technique simple.</p>
<p>Si le script détecte que c&rsquo;est une sandbox, il va faire une requête DNS vers <code>cest-sandbox.fr</code>, et s&rsquo;il détecte que c&rsquo;est une machine réelle, il va faire une requête vers <code>cest-reel.fr</code>. <em>(Note: Comme expliqué, c&rsquo;est techniquement une requête HTTP via WinInet, mais l&rsquo;intention de signalement est là).</em></p>
<p>Donc, sans plus attendre, lançons notre code sur <a href="https://app.any.run/">any.run</a>, qui est une sandbox très connue et qui permet, en plus de toutes les fonctionnalités incroyables qu&rsquo;elle possède, d&rsquo;interagir avec la VM.</p>
<p>Vous trouverez ici : <a href="https://app.any.run/tasks/47dc616f-3aa9-4689-a912-34082f93b423">Tache Sandbox</a> l&rsquo;analyse.</p>
<p><img src="/images/cyber/sandbox/anyrun.png" alt="alt text"></p>
<p>Comme vous pouvez le constater, notre script a bel et bien fait une requête vers <code>cest-sandbox.fr</code>, prouvant que notre script a bien détecté qu&rsquo;il était dans une sandbox. Cela est crucial, car si j&rsquo;avais voulu, j&rsquo;aurais pu cacher derrière ce script un malware, qui n&rsquo;aurait peut-être jamais été découvert par Any.Run lors d&rsquo;une analyse rapide.</p>
<p>Mais bon, cela, c&rsquo;était juste Any.Run. Si on lance mon script sur VirusTotal, c&rsquo;est une tout autre histoire&hellip;</p>
<p><img src="/images/cyber/sandbox/vt-scan.png" alt="Virus Total scan"></p>
<p>Il a été détecté par 13 antivirus sur 73, et classifié comme Trojan&hellip; La raison, c&rsquo;est la méthode d&rsquo;analyse de VirusTotal. En effet, VirusTotal effectue principalement de l&rsquo;analyse statique (et des analyses comportementales dans ses propres sandboxes, dont les rapports sont visibles dans l&rsquo;onglet &ldquo;Behavior&rdquo;).</p>
<p>Lors de l&rsquo;analyse statique, VT va se dire par exemple : &ldquo;Tiens, ce binaire utilise des appels réseau WinInet, fait des checks système, alloue certains patterns de données… Ça ressemble à du malware&rdquo;.</p>
<p>Et donc, il va le détecter comme tel. Également, mon script est extrêmement simple, et donc je suis sûr que certains moteurs, pour ne pas dire la majorité, ont été entraînés avec des milliers de samples qui ressemblent au mien et qui, de base, ne font pas des choses très sympathiques. Le moteur le détecte donc comme un malware par association de patterns.</p>
<p>Ce qu&rsquo;on pourrait essayer dans un prochain post, c&rsquo;est de passer par de l&rsquo;obfuscation, avec des outils comme UPX ou autres&hellip; (Ne jugez pas, je ne suis pas un expert en obfuscation ni en reverse engineering !)</p>
<h2 id="conclusion">Conclusion</h2>
<p>Voilà pour cette exploration de l&rsquo;évasion de sandbox ! Prochaine étape ? Peut-être creuser l&rsquo;obfuscation et d&rsquo;autres techniques anti-analyse pour aller plus loin dans la discrétion.</p>
<p>Merci beaucoup pour votre lecture et à bientôt !</p>

        </p>
        
        
            <script
  type="application/javascript"
  src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"
></script>
<script>
  var config = {
    startOnLoad: true,
    theme:'dark',
    align:'center',
  };
  mermaid.initialize(config);
</script>
        
    </div>

    <div class="prev-next">
        
            
                
<div class="prev-post">
    <p>
        <a href="/posts/docs/ia/n8n-cyber-2/">
            &#8592;
            :
            Agent IA n8n prend vie avec VirusTotal (Partie 2)
        </a>
    </p>
    <p class="prev-post-date">
        avril 2, 2025
    </p>
</div>



<div class="next-post">
    <p>
        <a href="/posts/sysadmin/microvm/microvm-1/">
            :
            MicroVM - À la découverte
            &#8594;
        </a>
    </p>
        <p class="next-post-date">
            avril 13, 2025
        </p>
</div>


            
        
    </div>
</div>



    

        </main><footer class="footer">
    
    

    
    <span>&copy; 2025 makhal.fr</span>
    
</footer>
</body>
</html>
