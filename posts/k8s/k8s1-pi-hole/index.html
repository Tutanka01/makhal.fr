<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Déployer Pi-hole sur Kubernetes</title>
    <meta name="description" content="">
    <meta name="keywords" content='blog, makhal, cyber, SIEM, BUT R&amp;T, kubernetes, docker, devops'>

    <meta property="og:url" content="https://makhal.fr/posts/k8s/k8s1-pi-hole/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Déployer Pi-hole sur Kubernetes">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://makhal.fr/images/avatar.jpg">
    <meta property="og:image:secure_url" content="https://makhal.fr/images/avatar.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Déployer Pi-hole sur Kubernetes">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://makhal.fr/posts/k8s/k8s1-pi-hole/">
    <meta property="twitter:url" content="https://makhal.fr/posts/k8s/k8s1-pi-hole/">
    <meta name="twitter:image" content="https://makhal.fr/images/avatar.jpg">

    
    <link rel="canonical" href="https://makhal.fr/posts/k8s/k8s1-pi-hole/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.893af8dd3b65bd0ffe90e7af33847bd6dc9180b8fa6d6659a212a6f4b62d3e01.js" integrity="sha256-iTr43TtlvQ/&#43;kOevM4R71tyRgLj6bWZZohKm9LYtPgE="></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6QF6WSBEBS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-6QF6WSBEBS');
    </script>
    
    
          <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">
        
        
            <div class="avatar">
                <a href="https://makhal.fr/">
                    <img src="https://makhal.fr//images/avatar.jpg" alt="avatar" />
                </a>
            </div>
        

        
        <div class="nav-title">
            <a class="nav-brand" href="https://makhal.fr/">makhal.fr</a>
        </div>

        
        <div class="nav-links">
            
                <div class="nav-link">
                    <a href="https://makhal.fr/posts/"> Posts </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://makhal.fr/tags/"> Tags </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://makhal.fr/pages/about/"> Bio </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://www.linkedin.com/in/mohamad-el-akhal-8b8319221/"><span data-feather='linkedin'></span>  </a>
                </div>
            
                <div class="nav-link">
                    <a href="https://github.com/tutanka01"><span data-feather='github'></span>  </a>
                </div>
            

            
            <span class="nav-icons-divider"></span>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">   
                
                    <li class="nav-item">
                        <a href="https://makhal.fr/posts/"> Posts </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://makhal.fr/tags/"> Tags </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://makhal.fr/pages/about/"> Bio </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://www.linkedin.com/in/mohamad-el-akhal-8b8319221/"><span data-feather='linkedin'></span>  </a>
                    </li>
                
                    <li class="nav-item">
                        <a href="https://github.com/tutanka01"><span data-feather='github'></span>  </a>
                    </li>
                
        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Déployer Pi-hole sur Kubernetes</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            mars 2, 2025
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://makhal.fr/tags/kubernetes">kubernetes</a></li>
        
            <li class="post-tag"><a href="https://makhal.fr/tags/docker">docker</a></li>
        
            <li class="post-tag"><a href="https://makhal.fr/tags/devops">devops</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>Dans le dernier <a href="/posts/k8s/k8s1-3/">article</a> de notre série sur Kubernetes, nous avons vu comment déployer un cluster Kubernetes en utilisant <code>K3s</code>. Aujourd&rsquo;hui, on va changer d&rsquo;application à déployer, et on va installer un serveur Pi-hole sur notre cluster.</p>
<p>Bien entendu, notre Pi-hole sera distribué sur les différents nœuds de notre cluster, pour une haute disponibilité. On va donc parler de LoadBalancer, de Deployment&hellip; Bref, on va s&rsquo;amuser !</p>
<p>Mais pourquoi faire ça ? Eh bien, l&rsquo;idée, c&rsquo;est d&rsquo;avoir un Pi-hole qui ne tombe jamais en rade. Si un serveur lâche, Kubernetes prend le relais et Pi-hole continue de tourner. C&rsquo;est ça, la magie du HA (Haute Disponibilité) ! Et puis, ça me permet de bidouiller Kubernetes, c&rsquo;est toujours bon pour apprendre.</p>
<h2 id="pi-hole--quest-ce-que-cest-">Pi-hole : Qu&rsquo;est-ce que c&rsquo;est ?</h2>
<p>Avant de commencer quoi que ce soit, il faut comprendre ce qu&rsquo;est Pi-hole. Pi-hole, c&rsquo;est un serveur DNS, mais pas n&rsquo;importe lequel. Il est hébergé sur votre réseau local, et il sert à bloquer les pubs et les trackers. En gros, il est là pour protéger votre vie privée et vous éviter les publicités intempestives. C&rsquo;est un peu comme un AdBlocker, mais au niveau de tout votre réseau !</p>
<p>J&rsquo;avais déjà un Pi-hole dans le passé, qui marchait très bien. Mais j&rsquo;ai décidé de le déployer sur mon cluster Kubernetes, pour en apprendre un peu plus sur Kubernetes et pour voir tous les problèmes que je pourrais rencontrer. Et je peux vous dire, il y en a eu !</p>
<h2 id="architecture">Architecture</h2>
<p>Pour rappel, notre cluster Kubernetes est composé de 3 nœuds : un master et deux workers. Voilà à quoi ressemble notre architecture :</p>
<div class="mermaid">
graph TD
    %% Éléments principaux simplifiés
    Internet((Internet)) 
    PC[PC Mohamad]
    Switch[Switch]
    
    %% Architecture simplifiée
    subgraph Proxmox1[Serveur Proxmox 1]
        Master[Kubernetes Master Node]
    end
    
    subgraph Proxmox2[Serveur Proxmox 2]
        Worker1[Kubernetes Worker 1]
        Worker2[Kubernetes Worker 2]
    end
    
    %% Connexions simplifiées et directes
    Internet --> PC
    PC --> Switch
    Switch --> Proxmox1
    Switch --> Proxmox2
    
    %% Relations Kubernetes claires
    Master --> Worker1
    Master --> Worker2
    
    %% Application Pi-Hole sur les deux workers
    Worker1 --> PiHole1[Pi-Hole 1]
    Worker2 --> PiHole2[Pi-Hole 2]
    
    %% Load Balancer MetalLB
    Switch --> LB[MetalLB Load Balancer]
    LB --> Worker1
    LB --> Worker2
    
    %% Styling adapté aux couleurs de votre site
    classDef proxmox fill:#FF9966,stroke:#333,stroke-width:1px,color:#000
    classDef k8s fill:#4169E1,stroke:#fff,color:#fff,stroke-width:1px
    classDef network fill:#87CEFA,stroke:#333,stroke-width:1px,color:#000
    classDef internet fill:#58D68D,stroke:#333,stroke-width:1px,color:#000
    classDef client fill:#F4D03F,stroke:#333,stroke-width:1px,color:#000
    classDef pihole fill:#AA4444,stroke:#fff,color:#fff,stroke-width:1px
    classDef loadbalancer fill:#90EE90,stroke:#333,color:#000,stroke-width:1px
    
    class Proxmox1,Proxmox2 proxmox
    class Master,Worker1,Worker2 k8s
    class Switch network
    class Internet internet
    class PC client
    class PiHole1,PiHole2 pihole
    class LB loadbalancer
</div>
<p>Une petite explication s&rsquo;impose, je pense.</p>
<p>L&rsquo;architecture est composée de différents éléments :</p>
<ul>
<li>Internet : Donne accès au monde extérieur</li>
<li>PC Mohamad : Mon PC, c&rsquo;est le pont (routeur) entre mon home lab et internet</li>
<li>Switch : Permet de connecter les différents éléments de mon home lab</li>
<li>Serveur Proxmox 1/2 : Serveurs physiques qui hébergent mes VMs</li>
<li>Kubernetes Master Node : Le nœud master de mon cluster Kubernetes</li>
<li>Kubernetes Worker 1/2 : Les nœuds workers de mon cluster Kubernetes</li>
<li>Pi-Hole 1/2 : Les deux instances de Pi-hole que nous allons déployer sur notre cluster</li>
<li>MetalLB Load Balancer : Le Load Balancer qui va distribuer le trafic vers nos Pi-hole.</li>
</ul>
<p>Pour travailler dans le confort de mon PC, j&rsquo;ai copié les fichiers de configuration de mon cluster Kubernetes sur mon PC. Cela me permet d&rsquo;utiliser la commande <code>kubectl</code> directement depuis mon PC, grâce à la commande :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scp user@192.168.100.100:/etc/rancher/k3s/k3s.yaml config
</span></span></code></pre></div><h2 id="avant-de-commencer">Avant de commencer</h2>
<p>Avant de commencer, il y a une multitude de choses à faire. On sait que notre objectif est de déployer Pi-hole sur notre cluster Kubernetes. Mais avant de le faire, il faut comprendre que notre Pi-hole aura besoin de stockage persistant.</p>
<p>Pourquoi ? Parce que Pi-hole a besoin de stocker des données, comme les listes de blocage, la configuration DNS et les statistiques. Si jamais un Pod est détruit, les données seraient perdues. De plus, notre objectif est que Pi-hole soit sur plusieurs nœuds, donc il faut que les données soient partagées entre les différents nœuds.</p>
<p>Pour ça, on va utiliser <strong><a href="https://longhorn.io/">Longhorn</a></strong>, un système de stockage persistant pour Kubernetes. Longhorn, en gros, ça prend le stockage des nœuds et ça le transforme en un stockage distribué et redondant. C&rsquo;est parfait pour notre cas d&rsquo;utilisation. Il va créer des volumes persistants (PersistentVolumes - PV) et nous, on va créer des requêtes de volume persistant (PersistentVolumeClaims - PVC) pour dire à Kubernetes qu&rsquo;on a besoin d&rsquo;un volume pour stocker nos données Pi-hole.</p>
<p><img src="/images/k8s/k8s4-pihole/longhorn-horizontal-color.png" alt="Long-Horn"></p>
<p>Pour l&rsquo;installer, il existe différentes façons de procéder. La plus difficile est de le faire manuellement, donc écrire les différents fichiers de configuration, les appliquer, etc. La plus simple est d&rsquo;utiliser <strong>Helm</strong>, un gestionnaire de packages pour Kubernetes. C&rsquo;est un peu comme un <strong>apt</strong> pour Kubernetes. On va donc utiliser Helm pour installer Longhorn.</p>
<h3 id="installation-de-longhorn">Installation de Longhorn</h3>
<p>On va donc installer Longhorn en utilisant <strong>Helm</strong>. Pour ça, je vais utiliser un outil qui va me permettre d&rsquo;organiser tous les différents helm charts qu&rsquo;on va utiliser pour ce projet. Cet outil s&rsquo;appelle <strong>Helmfile</strong>.</p>
<p>Pour installer cet outil, il faudra simplement télécharger le binaire, et le mettre dans votre PATH. Voici le <a href="https://github.com/helmfile/helmfile/releases/tag/v0.171.0">GITHUB</a> du projet.</p>
<blockquote>
<p>Pour Linux, il suffira de déplacer le binaire dans le path <code>/usr/bin</code> ou <code>/usr/local/bin</code> par exemple.</p></blockquote>
<p>Pourquoi Helmfile ? Eh bien, Helmfile permet de gérer plusieurs charts Helm dans un seul fichier. Ça simplifie la gestion de tes applications Kubernetes, surtout quand on a plusieurs dépendances.</p>
<p>Il faut également installer le binaire de <strong>Helm</strong>. Pour ça, il suffit de télécharger le binaire depuis le <a href="https://github.com/helm/helm/releases">site officiel</a>, et de le déplacer dans votre PATH.</p>
<p>Maintenant, avant de faire quoi que ce soit, il faut connaître la dernière version de Longhorn. Pour ça, on va utiliser la commande suivante :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mohamad@debian:~$ helm search repo longhorn
</span></span><span style="display:flex;"><span>NAME                    CHART VERSION   APP VERSION     DESCRIPTION
</span></span><span style="display:flex;"><span>longhorn/longhorn       1.8.0           v1.8.0          Longhorn is a distributed block storage system ...
</span></span></code></pre></div><p>Donc la dernière version de Longhorn est la 1.8.0. On va donc créer un fichier <code>helmfile.yaml</code> qui va contenir les différents helm charts qu&rsquo;on va utiliser pour ce projet, en commençant bien entendu par Longhorn.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">repositories</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://charts.longhorn.io</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">longhorn-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#ae81ff">longhorn/longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">1.8.0</span>
</span></span></code></pre></div><p>Rien de bien compliqué. On définit le repository de Longhorn, et on définit la release de Longhorn. Maintenant, pour que helmfile puisse marcher correctement, il faut lui faire installer certains plugins. Pour ça, on va lancer la commande suivante :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helmfile init
</span></span></code></pre></div><p>Il va ensuite vous demander si vous voulez installer tel ou tel plugin, il suffit de répondre <code>y</code> à chaque fois, comme dans l&rsquo;image ci-dessous :</p>
<p><img src="/images/k8s/k8s4-pihole/install-plugins.png" alt="Install plugins"></p>
<p>Maintenant, lançons la commande suivante pour installer Longhorn :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helmfile apply
</span></span></code></pre></div><p>Et vous devriez voir quelque chose comme ça :</p>


<style>
  .video-container {
    position: relative;
    width: 100%;
    max-width: 850px; /* Limite la largeur maximale de la vidéo */
    height: auto;
    margin: 0 auto; /* Centre la vidéo horizontalement */
  }

  .video-container video {
    width: 100%; /* La vidéo prendra 100% de la largeur du conteneur */
    height: auto; /* La hauteur sera ajustée proportionnellement */
  }
</style>

<div class="video-container">
  <video controls src="/images/k8s/k8s4-pihole/apply.mp4" title="Title"></video>
</div>

<p>Et voilà, Longhorn est installé. Bon, pas tout à fait&hellip; Si on regarde l&rsquo;état des pods, on verra que Longhorn n&rsquo;est pas encore installé correctement et qu&rsquo;il est même en train de crasher en boucle.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mohamad@debian:~$ kubectl get pods -n longhorn-system
</span></span><span style="display:flex;"><span>NAME                                        READY   STATUS             RESTARTS      AGE
</span></span><span style="display:flex;"><span>longhorn-driver-deployer-7fc7ffcb7f-qkgnz   0/1     Init:0/1           <span style="color:#ae81ff">0</span>             109s
</span></span><span style="display:flex;"><span>longhorn-manager-89n8c                      1/2     CrashLoopBackOff   <span style="color:#ae81ff">3</span> <span style="color:#f92672">(</span>37s ago<span style="color:#f92672">)</span>   109s
</span></span><span style="display:flex;"><span>longhorn-manager-bhsfq                      1/2     CrashLoopBackOff   <span style="color:#ae81ff">3</span> <span style="color:#f92672">(</span>48s ago<span style="color:#f92672">)</span>   109s
</span></span><span style="display:flex;"><span>longhorn-manager-vjlgk                      1/2     CrashLoopBackOff   <span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>12s ago<span style="color:#f92672">)</span>   109s
</span></span><span style="display:flex;"><span>longhorn-ui-5fcc4bcfc7-c49t4                1/1     Running            <span style="color:#ae81ff">0</span>             109s
</span></span><span style="display:flex;"><span>longhorn-ui-5fcc4bcfc7-qbrwl                1/1     Running            <span style="color:#ae81ff">0</span>             109s
</span></span></code></pre></div><p>Pourquoi ? Regardons les logs du pod <code>longhorn-manager-bhsfq</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mohamad@debian:~$ kubectl logs longhorn-manager-bhsfq -n longhorn-system
</span></span><span style="display:flex;"><span>Defaulted container <span style="color:#e6db74">&#34;longhorn-manager&#34;</span> out of: longhorn-manager, pre-pull-share-manager-image
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2025-03-01T13:43:57Z&#34;</span> level<span style="color:#f92672">=</span>fatal msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Error starting manager: failed to check environment, please make sure you have iscsiadm/open-iscsi installed on the host: failed to execute: /usr/bin/nsenter [nsenter --mount=/host/proc/10422/ns/mnt --net=/host/proc/10422/ns/net iscsiadm --version], output , stderr nsenter: failed to execute iscsiadm: No such file or directory\n: exit status 127&#34;</span> func<span style="color:#f92672">=</span>main.main.DaemonCmd.func3 file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;daemon.go:105&#34;</span>
</span></span></code></pre></div><p>Le message est clair, il manque le package <code>iscsiadm</code> sur le host. Pour l&rsquo;installer, il suffit de lancer la commande suivante sur chaque nœud de votre cluster :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install open-iscsi
</span></span></code></pre></div><p>Mais bon, aller à la main sur chaque nœud nous enlève cet esprit &ldquo;infrastructure as code&rdquo;. Donc on va utiliser Ansible pour automatiser cette tâche. Pour ça, on va créer un playbook Ansible qui va installer le package <code>open-iscsi</code> sur chaque nœud de notre cluster. Voici le playbook :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install open-iscsi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apt</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">open-iscsi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><p>Et une fois lancé, on aura ça comme résultat :</p>


<style>
  .video-container {
    position: relative;
    width: 100%;
    max-width: 850px; /* Limite la largeur maximale de la vidéo */
    height: auto;
    margin: 0 auto; /* Centre la vidéo horizontalement */
  }

  .video-container video {
    width: 100%; /* La vidéo prendra 100% de la largeur du conteneur */
    height: auto; /* La hauteur sera ajustée proportionnellement */
  }
</style>

<div class="video-container">
  <video controls src="/images/k8s/k8s4-pihole/ansible-fast.mp4" title="Title"></video>
</div>

<p>Ce n&rsquo;est pas mieux comme ça ? Maintenant, juste au cas où, on va supprimer le namespace <code>longhorn-system</code> et on va relancer l&rsquo;installation de Longhorn :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete namespace longhorn-system
</span></span><span style="display:flex;"><span>helmfile apply
</span></span></code></pre></div><p>Puis, on va vérifier que tout est bien installé :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mohamad@debian:~$ kubectl get pods -n longhorn-system
</span></span><span style="display:flex;"><span>NAME                                                READY   STATUS              RESTARTS      AGE
</span></span><span style="display:flex;"><span>csi-attacher-79866cdcf8-66xd9                       1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-attacher-79866cdcf8-hpd9g                       1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-attacher-79866cdcf8-jbhhl                       1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-provisioner-664cb5bdd5-hxlxr                    1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-provisioner-664cb5bdd5-kt7hh                    1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-provisioner-664cb5bdd5-sm4pl                    1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-resizer-64f6fb4459-drptz                        1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>csi-resizer-64f6fb4459-jgwz8                        1/1     Running             <span style="color:#ae81ff">0</span>             13s
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>longhorn-manager-nvl4n                              2/2     Running             <span style="color:#ae81ff">0</span>             71s
</span></span><span style="display:flex;"><span>longhorn-manager-v5c24                              2/2     Running             <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>62s ago<span style="color:#f92672">)</span>   71s
</span></span><span style="display:flex;"><span>longhorn-ui-5fcc4bcfc7-9wrth                        1/1     Running             <span style="color:#ae81ff">0</span>             71s
</span></span><span style="display:flex;"><span>longhorn-ui-5fcc4bcfc7-g6wds                        1/1     Running             <span style="color:#ae81ff">0</span>             71s
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Donc Longhorn est installé correctement. On peut maintenant passer à l&rsquo;installation de Pi-hole.</p>
<p>Maintenant qu&rsquo;on a notre stockage persistant, il faut qu&rsquo;on puisse avoir une seule adresse IP pour accéder à notre Pi-hole. Pour ça, on va utiliser un LoadBalancer. On va utiliser <strong>MetalLB</strong>, un LoadBalancer pour Kubernetes. En gros, MetalLB va prendre une IP de notre réseau et la donner au service Pi-hole. Comme ça, on aura toujours la même IP pour accéder à Pi-hole, même si les pods changent de nœud. Pour l&rsquo;installer, on ne va pas changer la méthode qui gagne, on va utiliser Helm. Voici le contenu de notre fichier <code>helmfile.yaml</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">repositories</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://charts.longhorn.io</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metallb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://metallb.github.io/metallb</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">longhorn-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#ae81ff">longhorn/longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">1.8.0</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metallb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#ae81ff">metallb/metallb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">0.14.9</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span></code></pre></div><p>Maintenant, on va lancer la commande suivante pour installer MetalLB :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helmfile apply
</span></span></code></pre></div><p>Et voilà, MetalLB est installé. Pour vérifier que tout est bien installé, on va lancer la commande suivante :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mohamad@debian:~$ kubectl get pods -n metallb-system
</span></span><span style="display:flex;"><span>NAME                                 READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>metallb-controller-dc88974b6-k7wc8   1/1     Running   <span style="color:#ae81ff">0</span>          2m55s
</span></span><span style="display:flex;"><span>metallb-speaker-5jllp                4/4     Running   <span style="color:#ae81ff">0</span>          2m55s
</span></span><span style="display:flex;"><span>metallb-speaker-cx2j6                4/4     Running   <span style="color:#ae81ff">0</span>          2m55s
</span></span><span style="display:flex;"><span>metallb-speaker-zt86w                4/4     Running   <span style="color:#ae81ff">0</span>          2m55s
</span></span></code></pre></div><blockquote>
<p>Il faudra attendre quelques minutes pour que MetalLB soit installé correctement, et passe son étape d&rsquo;<em>init</em>.</p></blockquote>
<p>Maintenant, on doit configurer MetalLB pour qu&rsquo;il puisse fonctionner correctement, comme par exemple lui donner le range d&rsquo;adresses IP qu&rsquo;il pourra utiliser. Pour faire ça, il existe différentes façons. Pour configurer correctement MetalLB, je vais utiliser <strong>Kustomize</strong>.</p>
<p>Kustomize va nous permettre de créer un fichier de configuration pour MetalLB et de le déployer sur notre cluster Kubernetes. On peux considérer Kustomize comme un gestionnaire de configuration pour Kubernetes. C&rsquo;est super pratique pour éviter de répéter des configs et pour gérer facilement les différences entre les environnements.</p>
<p>Tout d&rsquo;abord, il faudra créer un nouveau fichier, le mien je l&rsquo;ai nommé <code>kustomization.yaml</code> et il contient le contenu suivant :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">commonLabels</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app.kubernetes.io/managed-by</span>: <span style="color:#ae81ff">Kustomize</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">./metallb/pool.yaml</span>
</span></span></code></pre></div><p>Ensuite, on va créer la config en soi, donc créer un dossier <code>metallb</code> et dedans créer un fichier <code>pool.yaml</code> qui contient le contenu suivant :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">IPAddressPool</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pool</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">192.168.100.32</span><span style="color:#ae81ff">/27</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">L2Advertisement</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pool</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ipAddressPools</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">pool</span>
</span></span></code></pre></div><p>Le range dans <code>addresses</code> est le range d&rsquo;adresses IP que MetalLB pourra utiliser. Dans mon cas, je suis dans un réseau 192.168.100.0/24 et j&rsquo;ai choisi le range 192.168.100.32/27, pour que je puisse avoir les adresses utilisables :</p>
<ul>
<li>192.168.100.33 à 192.168.100.62</li>
</ul>
<p>Également, j&rsquo;ai fait une deuxième ressource de type <code>L2Advertisement</code> qui permet à MetalLB de faire de la pub pour les adresses IP qu&rsquo;il a à disposition. Donc couche 2 qui est la couche mac. MetalLB utilise le protocole ARP (Address Resolution Protocol) pour annoncer ces adresses au réseau local. C&rsquo;est comme ça que notre PC sait que l&rsquo;IP 192.168.100.250 est accessible via MetalLB.</p>
<p>Une fois qu&rsquo;on a fait, rien de plus compliqué que de lancer la commande suivante :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -k .
</span></span></code></pre></div><blockquote>
<p>Il faut être dans le même dossier que le fichier <code>kustomization.yaml</code> :)</p></blockquote>
<p>Et normalement, vous verrez quelque chose comme ça :</p>


<style>
  .video-container {
    position: relative;
    width: 100%;
    max-width: 850px; /* Limite la largeur maximale de la vidéo */
    height: auto;
    margin: 0 auto; /* Centre la vidéo horizontalement */
  }

  .video-container video {
    width: 100%; /* La vidéo prendra 100% de la largeur du conteneur */
    height: auto; /* La hauteur sera ajustée proportionnellement */
  }
</style>

<div class="video-container">
  <video controls src="/images/k8s/k8s4-pihole/kustomize.mp4" title="Title"></video>
</div>

<p>Et voilà, MetalLB est configuré correctement. On peut maintenant passer à l&rsquo;installation de Pi-hole.</p>
<h2 id="installation-de-pi-hole">Installation de Pi-hole</h2>
<p>Pour l&rsquo;installation de notre Pi-hole, on va continuer sur notre lancée, et on va utiliser Helm. Pour ça, on va modifier notre fichier <code>helmfile.yaml</code> pour ajouter la release de Pi-hole :</p>
<p>Voilà à quoi va ressembler notre fichier <code>helmfile.yaml</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">repositories</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://charts.longhorn.io</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metallb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://metallb.github.io/metallb</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mojo2600</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://mojo2600.github.io/pihole-kubernetes/</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">longhorn-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#ae81ff">longhorn/longhorn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">1.8.0</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metallb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#ae81ff">metallb/metallb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">0.14.9</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pihole</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">pihole-system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#ae81ff">mojo2600/pihole</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">2.27.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./values/pihole.values.yaml</span>
</span></span></code></pre></div><p>Également, j&rsquo;ai dû ajouter un fichier <code>values.yaml</code> qui contient certains paramètres qui seront utilisés pour lancer Pi-hole. Voici le contenu de ce fichier :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">persistenVolumeClaim</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serviceWeb</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#ae81ff">192.168.100.250</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metallb.universe.tf/allow-shared-ip</span>: <span style="color:#ae81ff">pihole-svc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serviceDns</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#ae81ff">192.168.100.250</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metallb.universe.tf/allow-shared-ip</span>: <span style="color:#ae81ff">pihole-svc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">replicaCount</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Donc rien de très compliqué, on dit simplement qu&rsquo;on veut qu&rsquo;il y ait du persistent storage. On définit l&rsquo;adresse IP qu&rsquo;on veut utiliser pour le LoadBalancer. L&rsquo;annotation <code>metallb.universe.tf/allow-shared-ip: pihole-svc</code> est importante. Elle permet à MetalLB de partager la même IP entre plusieurs services. Ici, on l&rsquo;utilise pour partager l&rsquo;IP entre le service web (pour l&rsquo;interface d&rsquo;administration) et le service DNS.</p>
<p>Maintenant, on va lancer la commande suivante pour installer Pi-hole :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helmfile apply
</span></span></code></pre></div><p>Et voilà, Pi-hole est installé. Pour vérifier que tout est bien installé, on va lancer la commande suivante :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mohamad@debian:~$ kubectl get svc -n pihole-system
</span></span><span style="display:flex;"><span>NAME             TYPE           CLUSTER-IP      EXTERNAL-IP       PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                      AGE
</span></span><span style="display:flex;"><span>pihole-dhcp      NodePort       10.43.227.177   &lt;none&gt;            67:30868/UDP                 7m59s
</span></span><span style="display:flex;"><span>pihole-dns-tcp   LoadBalancer   10.43.57.10     192.168.100.250   53:30898/TCP                 7m59s
</span></span><span style="display:flex;"><span>pihole-dns-udp   LoadBalancer   10.43.92.96     192.168.100.250   53:31650/UDP                 7m59s
</span></span><span style="display:flex;"><span>pihole-web       LoadBalancer   10.43.110.72    192.168.100.250   80:31936/TCP,443:32195/TCP   7m59s
</span></span></code></pre></div><p>Si tu vois une adresse IP dans la colonne <code>EXTERNAL-IP</code>, c&rsquo;est que MetalLB a bien fait son boulot !</p>
<h2 id="conclusion">Conclusion</h2>
<p>Voilà, Pi-hole est maintenant déployé sur notre cluster Kubernetes ! C&rsquo;est pas de la magie, mais presque. On a utilisé Longhorn pour le stockage persistant, MetalLB pour l&rsquo;équilibrage de charge et Helm pour simplifier l&rsquo;installation. Maintenant, on peux profiter d&rsquo;un Pi-hole haute disponibilité et d&rsquo;une vie privée un peu mieux protégée.</p>
<p>Si jamais vous voulez un autre post ou j&rsquo;explique comment configurer Pi-hole, n&rsquo;hésitez pas à me le dire par message Linkedin !</p>

        </p>
        
        
            <script
  type="application/javascript"
  src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"
></script>
<script>
  var config = {
    startOnLoad: true,
    theme:'dark',
    align:'center',
  };
  mermaid.initialize(config);
</script>
        
    </div>

    <div class="prev-next">
        
            
                
<div class="prev-post">
    <p>
        <a href="/posts/sysadmin/kasm-post/">
            &#8592;
            :
            KASM - Navigateur et OS jetables
        </a>
    </p>
    <p class="prev-post-date">
        février 19, 2025
    </p>
</div>



<div class="next-post">
    <p>
        <a href="/posts/cyber/poc/defenderui/">
            :
            Booster Defender gratuitement avec Defender UI
            &#8594;
        </a>
    </p>
        <p class="next-post-date">
            mars 14, 2025
        </p>
</div>


            
        
    </div>
</div>



    

        </main><footer class="footer">
    
    

    
    <span>&copy; 2025 makhal.fr</span>
    
</footer>
</body>
</html>
